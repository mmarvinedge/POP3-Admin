<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core" xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:adm="http://github.com/adminfaces"
                template="#{layoutMB.template}"
                xmlns:pop="http://xmlns.jcp.org/jsf/composite/pop">

    <ui:define name="metadata">
        <ui:param name="title" value="Produtos" /> <!-- Automatic create breadCrumb and page title when param 'title' is provided. --> 

        <style type="text/css">
            .ui-datatable .ui-datatable-header {
                text-align: right !important;
            }
        </style>
    </ui:define>

    <ui:define name="description">
        Controle seus Produtos
    </ui:define>

    <ui:define name="body">
        <h:form id="frmProduct" >
            <p:focus context="@form"/>
            <div class="box box-primary">
                <div class="box-header with-border">
                    <div id="main-buttons" class="hidden-sm hidden-xs">

                        <p:commandButton action="#{productMB.novo}" icon="fa fa-plus"
                                         value="Novo" styleClass="btn-primary" update="modalNewProduct" oncomplete="PF('modalNewProduct').show()"/>
                        <p:spacer width="5"/>
                        <p:splitButton value="Editar" action="#{productMB.setProductComplete(productMB.selectedProducts.get(0))}" update="@(.ui-dialog)" styleClass="btn-info"
                                       disabled="#{empty productMB.selectedProducts or productMB.selectedProducts.size() > 1}"
                                       oncomplete="PF('modalNewProduct').show()" icon="fa fa-edit">
                            <p:menuitem styleClass="btn-primary" icon="fa fa-copy" value="Copiar"  action="#{productMB.copyProduct()}" immediate="true" update=":frmNewProduct" oncomplete="PF('modalNewProduct').show()"  />
                        </p:splitButton>
                        <p:spacer width="5"/>
                        <p:commandButton value="Deletar" icon="fa fa-trash" styleClass="btn-danger"
                                         action="#{productMB.delete}"
                                         disabled="#{empty productMB.selectedProducts or productMB.selectedProducts.size() == 0}"
                                         process="@this" update="@form"
                                         >
                            <p:confirm header="Confirmação" message="Tem certeza?" icon="ui-icon-danger"/>
                        </p:commandButton>
                    </div>

                    <p:splitButton value="Novo" action="#{productMB.novo}"
                                   icon="fa fa-plus"  update="modalNewProduct" oncomplete="PF('modalNewProduct').show()"
                                   styleClass="hidden-md hidden-lg btn-primary">

                        <p:menuitem value="Editar" update="@(.ui-dialog)" action="#{productMB.setProductComplete()}"
                                    oncomplete="PF('modalNewProduct').show()"
                                    disabled="#{empty productMB.selectedProducts or productMB.selectedProducts.size() > 1}"
                                    icon="fa fa-edit"
                                    />
                        <p:menuitem value="Deletar" action="#{productMB.delete}"
                                    process="@this" update="@form"
                                    disabled="#{empty productMB.selectedProducts or productMB.selectedProducts.size() == 0}"
                                    icon="fa fa-trash">
                            <p:confirm header="Confirmação" message="Tem certeza?" icon="ui-icon-danger"/>
                        </p:menuitem>
                    </p:splitButton>

                    <p:separator/>
                    <p:dataTable id="tblProduct" widgetVar="productsTable" var="p" value="#{productMB.productModel}" rows="10"
                                 rowKey="#{p.id}" paginator="true" emptyMessage="Nenhum Produto encontrado"
                                 paginatorPosition="bottom" selection="#{productMB.selectedProducts}"
                                 paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown} {JumpToPageDropdown}"
                                 currentPageReportTemplate="[ {startRecord} - {endRecord} de {totalRecords} ]"
                                 rowsPerPageTemplate="10,20,30,40,50" >

                        <p:ajax event="rowSelectCheckbox" update="@(.ui-button)"/>
                        <p:ajax event="rowUnselectCheckbox" update="@(.ui-button)"/>
                        <p:ajax event="rowSelect" update="@(.ui-button)"/>
                        <p:ajax event="rowUnselect" update="@(.ui-button)"/>
                        <p:ajax event="toggleSelect" update="@(.ui-button)"/>

                        <p:column selectionMode="multiple" width="5%" styleClass="align-center"/>

                        <p:column headerText="Código" sortBy="#{p.sku}" filterBy="#{p.sku}" style="width: 10% !important" filterMatchMode="contains">
                            <h:outputText value="#{p.sku}" />
                        </p:column>
                        <p:column headerText="Descricão" sortBy="#{p.name}" filterBy="#{p.name}" filterMatchMode="contains">
                            <h:outputText value="#{p.name}" />
                        </p:column>
                        <p:column headerText="Preço Venda" sortBy="#{p.price}" filterBy="#{p.price}" filterMatchMode="contains">
                            <h:outputText value="#{p.price}" >
                                <f:convertNumber type="currency"/>
                            </h:outputText>
                        </p:column>
                        <p:column headerText="Categoria" sortBy="#{p.categoryMain.name}" filterBy="#{p.categoryMain.name}" filterMatchMode="contains">
                            <h:outputText value="#{p.categoryMain.name}" />
                        </p:column>
                        <p:column headerText="Ativo" >
                            <p:toggleSwitch value="#{p.enabled}" >
                                <p:ajax event="change" update="@this"  listener="#{productMB.update(p)}"/>
                            </p:toggleSwitch>
                        </p:column>

                        <p:column headerText="Impressora" >
                            <p:selectOneMenu  value="#{p.printer}" filter="true" >
                                <f:selectItem itemLabel="NAO IMPRIMIR" itemValue="NAO IMPRIMIR"/>
                                <f:selectItem itemLabel="BEBIDAS" itemValue="BEBIDAS"/>
                                <f:selectItem itemLabel="SUCOS" itemValue="SUCOS"/>
                                <f:selectItem itemLabel="REFRIGERANTES" itemValue="REFRIGERANTES"/>
                                <f:selectItem itemLabel="COZINHA" itemValue="COZINHA"/>
                                <f:selectItem itemLabel="PIZZARIA" itemValue="PIZZARIA"/>
                                <f:selectItem itemLabel="SALAO" itemValue="SALAO"/>
                                <f:selectItem itemLabel="CHURRASCARIA" itemValue="CHURRASCARIA"/>
                                <f:selectItem itemLabel="SALAO 2" itemValue="SALAO2"/>
                                <f:selectItem itemLabel="SALAO 3" itemValue="SALAO3"/>
                                <p:ajax event="itemSelect" update="@this"  listener="#{productMB.update(p)}"/>
                            </p:selectOneMenu>
                        </p:column>
<!--                        <p:column headerText="*" width="50" >
                            <p:commandButton   styleClass="btn-primary" icon="fa fa-copy"  action="#{productMB.copyProduct(p)}" immediate="true" update=":frmNewProduct" oncomplete="PF('modalNewProduct').show()" />
                        </p:column>-->

                    </p:dataTable>
                </div>
            </div>
            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" styleClass="box-danger box-solid">
                <p:commandButton value="Sim" type="button" styleClass="btn-material btn-primary ui-confirmdialog-yes"
                                 icon="fa fa-check"/>
                <p:commandButton value="Não" type="button" styleClass="btn-material btn-danger ui-confirmdialog-no"
                                 icon="fa fa-close"/>
            </p:confirmDialog>
        </h:form>




        <p:dialog widgetVar="modalNewProduct" id="modalNewProduct"  header="Cadastro de Produtos" draggable="false"
                  modal="true" position="top" responsive="false" resizable="false" positionType="absolute"
                  width="850" height="695">
            <h:form id="frmNewProduct">
                <p:tabView id="tabs">
                    <p:tab title="Dados do Produto">
                        <p:panel id="pnl" styleClass="box-primary card">
                            <div class="box-primary">
                                <div class="ui-g ui-fluid">
                                    <div class="ui-sm-3 ui-g-3 ">
                                        <p:outputLabel value="SKU" for="inptSku"/>
                                        <p:inputText id="inptSku" value="#{productMB.product.sku}"/>
                                        <span class="help-block"> 
                                            <p:message for="inptSku" /> 
                                        </span>
                                    </div>
                                    <div class="ui-sm-6 ui-g-6 ">     
                                        <p:outputLabel value="Nome" for="inptName"/>
                                        <p:inputText id="inptName" value="#{productMB.product.name}" required="true"/>
                                        <span class="help-block"> 
                                            <p:message for="inptName" /> 
                                        </span>
                                    </div>
                                    <div class="ui-sm-12 ui-g-3 ">
                                        <p:outputLabel value="Categoria" for="category"/>
                                        <p:selectOneMenu required="true" requiredMessage="Categoria é obrigatório"
                                                         value="#{productMB.product.categoryMain}" id="category" filter="true"
                                                         filterMatchMode="contains" effect="fade" converter="Converter"
                                                         >
                                            <f:selectItem itemLabel="Selecione uma categoria..." itemValue=""/>
                                            <f:selectItems value="#{productMB.categoryList}" var="cats" itemValue="#{cats}" itemLabel="#{cats.name}"/>
                                            <p:ajax event="itemSelect" update="@this, :frmNewProduct:tabs:pnl2" listener="#{productMB.debug()}" />
                                        </p:selectOneMenu>
                                        <span class="help-block"> 
                                            <p:message for="category" /> 
                                        </span>
                                    </div>
                                </div>
                                <div class="ui-g ui-fluid">

                                    <div class="ui-sm-6 ui-g-3 ">     
                                        <p:outputLabel value="Impressora" for="inptPrinter"/>
                                        <p:selectOneMenu id="inptPrinter" value="#{productMB.product.printer}" 
                                                         filter="true" required="true">
                                            <f:selectItem itemLabel="NAO IMPRIMIR" itemValue="NAO IMPRIMIR"/>
                                            <f:selectItem itemLabel="BEBIDAS" itemValue="BEBIDAS"/>
                                            <f:selectItem itemLabel="SUCOS" itemValue="SUCOS"/>
                                            <f:selectItem itemLabel="REFRIGERANTES" itemValue="REFRIGERANTES"/>
                                            <f:selectItem itemLabel="COZINHA" itemValue="COZINHA"/>
                                            <f:selectItem itemLabel="PIZZARIA" itemValue="PIZZARIA"/>
                                            <f:selectItem itemLabel="SALAO" itemValue="SALAO"/>
                                            <f:selectItem itemLabel="CHURRASCARIA" itemValue="CHURRASCARIA"/>
                                            <f:selectItem itemLabel="SALAO 2" itemValue="SALAO2"/>
                                            <f:selectItem itemLabel="SALAO 3" itemValue="SALAO3"/>
                                        </p:selectOneMenu>
                                        <span class="help-block"> 
                                            <p:message for="inptPrinter" /> 
                                        </span>
                                    </div>
                                    <div class="ui-sm-6 ui-g-3 ">     
                                        <p:outputLabel value="Preço" for="inptPrice"/>
                                        <p:inputNumber id="inptPrice" symbol="R$ " decimalSeparator="," thousandSeparator="." value="#{productMB.product.price}" required="true"/>
                                        <span class="help-block"> 
                                            <p:message for="inptPrice" /> 
                                        </span>
                                    </div>
                                    <div class="ui-sm-6 ui-g-2 ">
                                        <p:outputLabel value="Promocional" for="promo"/><br/>
                                        <p:selectBooleanCheckbox id="promo"  value="#{productMB.product.promo}" >
                                            <p:ajax event="change" update="ogirinalPrice" />
                                        </p:selectBooleanCheckbox>
                                    </div>    
                                    <div class="ui-sm-6 ui-g-3 ">
                                        <h:panelGroup id="ogirinalPrice" >
                                            <h:panelGroup rendered="#{productMB.product.promo}">
                                                <p:outputLabel value="Preço Original" for="inptPriceOriginal"/>
                                                <p:inputNumber id="inptPriceOriginal" symbol="R$ " decimalSeparator="," thousandSeparator="." value="#{productMB.product.priceOriginal}" required="true"/>
                                                <span class="help-block"> 
                                                    <p:message for="inptPriceOriginal" /> 
                                                </span>
                                            </h:panelGroup>
                                        </h:panelGroup>
                                    </div>     

                                </div>
                                <div class="ui-g ui-fluid">
                                    <div class="ui-sm-12 ui-g-12 ">     
                                        <p:outputLabel value="Descrição" for="inptObs"/>
                                        <p:inputTextarea id="inptObs" value="#{productMB.product.description}" />
                                        <span class="help-block"> 
                                            <p:message for="inptObs" /> 
                                        </span>
                                    </div>
                                    <div class="ui-sm-12 ui-g-8 ">
                                        <div class="img-wrap">
                                            <p:outputLabel value="Foto (100KB max)" />
                                            <p:fileUpload fileUploadListener="#{productMB.uploadPhoto}" mode="advanced" dragDropSupport="false"
                                                          uploadLabel="Enviar" cancelLabel="Cancelar" label="Escolher" auto="false"
                                                          update="photo" sizeLimit="500000" fileLimit="3"  />
                                            <hr/>
                                            <h:panelGroup id="photo">
                                                <h:panelGroup rendered="#{productMB.product.imageBase64 != null}">
                                                    <img src="#{productMB.product.imageBase64}" />
                                                </h:panelGroup>
                                            </h:panelGroup>
                                        </div>
                                    </div>
                                    <!--<div class="ui-sm-12 ui-g-8 ">
                                        <p:outputLabel value="URL Foto" />
                                        <p:inputText value="{productMB.product.imageBase64}" />
                                    </div>-->
                                </div>
                            </div>
                        </p:panel>
                    </p:tab>
                    <p:tab title="Regras" >
                        <p:panel id="pnl2" styleClass="box-primary card">

                            <div class="box-primary" style="width: 850px !important;">
                                <div class="ui-g ui-fluid">
                                    <div class="ui-sm-12 ui-g-8">
                                        <h:outputLabel value="Tipo do produto" /><br/>
                                        <p:selectOneButton id="buttonTipoProduto" value="#{productMB.type}">
                                            <f:selectItem itemValue="normal" itemLabel="Normal"/>
                                            <f:selectItem itemValue="pizza" itemLabel="Pizza" itemDisabled="#{productMB.product.categoryMain.name != 'Pizzas'}"/>
                                            <p:ajax update="@this, typeProduct" event="change"/>
                                        </p:selectOneButton>
                                    </div>
                                </div>
                                <div class="ui-g ui-fluid">
                                    <h:panelGroup id="typeProduct">
                                        <h:panelGroup rendered="#{productMB.type == 'normal'}">

                                            <p:fieldset id="fdlAdicionais" legend="Adicionais" style="    width: 790px;">
                                                <p:commandButton icon="fa fa-plus"  class="btn-success" style="position: absolute !important;right: 5px !important;margin-top: -75px !important;width: auto;;" action="#{productMB.addAttributeCorrect()}" update="blockAtributes" immediate="true"  />

                                                <div class="ui-g ui-fluid" style="width: 780px !important;">
                                                    <h:panelGroup  layout="block" id="blockAtributes">
                                                        <div class="ui-sm-12 ui-g-12">

                                                            <ui:repeat id="rpt" value="#{productMB.product.attributes}" var="atr" varStatus="vari">
                                                                <p:accordionPanel id="acord">
                                                                    <p:tab title="Grupo">
                                                                        <div class="ui-g ui-fluid">
                                                                            <div class="ui-sm-6 ui-g-6">
                                                                                Grupo
                                                                                <p:inputText value="#{atr.description}"  >
                                                                                    <p:ajax event="blur" update="@this" />
                                                                                </p:inputText>
                                                                            </div>
                                                                            <div class="ui-sm-2 ui-g-2">
                                                                                Regra
                                                                                <p:selectOneMenu value="#{atr.rule}" converter="Converter">
                                                                                    <f:selectItem itemLabel="Multiple" itemValue="Multiple" />
                                                                                    <f:selectItem itemLabel="Single" itemValue="Single" />
                                                                                    <p:ajax event="itemSelect" update="@this" />
                                                                                </p:selectOneMenu>
                                                                            </div>
                                                                            <div class="ui-sm-2 ui-g-2">
                                                                                Max
                                                                                <p:inputText value="#{atr.quantity}" >
                                                                                    <p:ajax event="blur" update="@this" />
                                                                                </p:inputText>
                                                                            </div>
                                                                            <div class="ui-sm-12 ui-g-12">
                                                                                <p:commandButton icon="fa fa-plus" update=":frmNewProduct:tabs:rpt:#{vari.index}:acord:tblAttributes" class="btn-success" style="position: absolute !important;right: 60px !important;margin-top: -75px !important;width: 50px;;" action="#{productMB.addAttributeValue(atr)}"  immediate="true"  />
                                                                                <p:commandButton icon="fa fa-trash"  class="btn-danger" style="position: absolute !important;right: 5px !important;margin-top: -75px !important;width: 50px;;" action="#{productMB.removeAtribute(atr)}"  immediate="true" update="@form"  />
                                                                                <p:dataTable value="#{atr.values}" var="att" id="tblAttributes" style="width: 100% !important;"
                                                                                             rowIndexVar="index" emptyMessage="Nenhum produto adicionado!"  >
                                                                                    <p:column headerText="SKU" width="100" style="text-align: left">
                                                                                        <p:inputText   value="#{att.sku}"  placeholder="Opcional" >
                                                                                            <p:ajax event="blur" process="@this" />
                                                                                        </p:inputText>
                                                                                    </p:column>
                                                                                    <p:column headerText="Produto" style="text-align: left">
                                                                                        <p:inputText id="addProduct" value="#{att.name}" required="true" requiredMessage="Produto é obrigatório">
                                                                                            <p:ajax event="blur" process="@this" />
                                                                                        </p:inputText>
                                                                                    </p:column>
                                                                                    <p:column headerText="Preço" width="100" style="text-align: right">
                                                                                        <p:inputNumber id="addPrice" symbol="R$ " decimalSeparator="," thousandSeparator="." value="#{att.price}" required="true" requiredMessage="Preço é obrigatório" >
                                                                                            <p:ajax event="blur" process="@this" />
                                                                                        </p:inputNumber>
                                                                                    </p:column>
                                                                                    <p:column width="50" style="text-align: center">
                                                                                        <center>
                                                                                            <p:commandButton icon="fa fa-trash" styleClass="btn btn-danger" immediate="true" update="tblAttributes" action="#{productMB.removeAtributeValue(atr, att)}" />
                                                                                        </center>
                                                                                    </p:column>
                                                                                </p:dataTable>
                                                                            </div>
                                                                        </div>
                                                                    </p:tab>
                                                                </p:accordionPanel>

                                                            </ui:repeat>
                                                        </div>
                                                    </h:panelGroup>
                                                </div>
                                            </p:fieldset>

                                        </h:panelGroup>

                                        <h:panelGroup rendered="#{productMB.type == 'pizza' and productMB.product.categoryMain.name == 'Pizzas'}">
                                            <p:fieldset legend="Configuracoes de Pizza" style="width: 770px;">
                                                <div class="ui-g ui-fluid">
                                                    <div class="ui-sm-4 ui-g-4">
                                                        <p:outputLabel value="Tamanho"  for="tam"/>
                                                        <p:selectOneMenu id="tam"  value="#{productMB.product.sizePizza}">
                                                            <f:selectItem itemLabel="Selecione" itemValue="" />
                                                            <f:selectItem itemLabel="Fatia" itemValue="Fatia" />
                                                            <f:selectItem itemLabel="Brotinho" itemValue="Brotinho" />
                                                            <f:selectItem itemLabel="Pequena" itemValue="Pequena" />
                                                            <f:selectItem itemLabel="Media" itemValue="Média" />
                                                            <f:selectItem itemLabel="Grande" itemValue="Grande" />
                                                            <f:selectItem itemLabel="Extra Grande" itemValue="Extra Grande" />
                                                            <f:selectItem itemLabel="Extra 1" itemValue="Extra 1" />
                                                            <f:selectItem itemLabel="Extra 2" itemValue="Extra 2" />
                                                            <f:selectItem itemLabel="Extra 3" itemValue="Extra 3" />
                                                        </p:selectOneMenu>
                                                    </div>
                                                    <div class="ui-sm-4 ui-g-3">
                                                        <p:outputLabel value="Máx Sabores Selecionaveis"  for="max"/>
                                                        <p:inputNumber id="max"  value="#{productMB.product.maxPizza}"  decimalPlaces="0"/>
                                                    </div>
                                                </div>
                                                <div class="ui-g ui-fluid">
                                                    <div class="ui-sm-4 ui-g-4">
                                                        <p:outputLabel value="Regra de Preço"  for="reg"/>
                                                        <p:selectOneRadio id="reg"  value="#{productMB.product.rulePricePizza}">
                                                            <f:selectItem itemLabel="Média" itemValue="Média" />
                                                            <f:selectItem itemLabel="Preço da Maior" itemValue="Maior" />
                                                        </p:selectOneRadio>
                                                    </div>
                                                </div>
                                                <div class="ui-g ui-fluid">
                                                    <div class="ui-sm-12 ui-g-8">
                                                        <p:outputLabel value="Sabores / Preço" /><br/>
                                                        <p:inputText value="#{productMB.flavorPizza.sku}" style="width: 15% !important;" placeholder="SKU" />
                                                        <p:inputText value="#{productMB.flavorPizza.flavor}" style="width: 45% !important;" id="flava"  placeholder="Sabor"/>
                                                        <p:inputNumber value="#{productMB.flavorPizza.price}" symbol="R$ " decimalSeparator="," thousandSeparator="." id="flavaPri" placeholder="Valor" size="15"  />
                                                        <p:commandButton icon="fa fa-plus" styleClass="btn-primary"   style="width: 10% !important;" action="#{productMB.addFlavor()}" update="tblFlavors, flava,flavaPri"/>
                                                        <hr/>
                                                        <p:dataTable id="tblFlavors" value="#{productMB.product.flavorsPizza}" var="flav" >
                                                            <p:column headerText="SKU" width="100" style="text-align: left">
                                                                #{flav.sku}
                                                            </p:column>
                                                            <p:column headerText="Sabor" style="text-align: left">
                                                                #{flav.flavor}
                                                            </p:column>
                                                            <p:column headerText="Preço">
                                                                <h:outputText value="#{flav.price}">
                                                                    <f:convertNumber type="currency"/>
                                                                </h:outputText>
                                                            </p:column>
                                                            <p:column headerText="*" width="50">
                                                                <p:commandButton styleClass="btn-danger" action="#{productMB.removeFlavor(flav)}" icon="fa fa-trash" update="tblFlavors" immediate="true"/>
                                                            </p:column>
                                                        </p:dataTable>
                                                    </div>
                                                    <div class="ui-sm-12 ui-g-12">

                                                    </div>

                                                </div>
                                            </p:fieldset>
                                        </h:panelGroup>
                                    </h:panelGroup>
                                </div>

                            </div>
                        </p:panel>
                    </p:tab>
                </p:tabView>
                <div id="main-buttons" style="text-align: right;">
                    <p:commandButton value="Salvar" action="#{productMB.save}" update="@form, :frmProduct" icon="fa fa-check" type="submit" styleClass="btn-primary" oncomplete="if (!args.validationFailed)  {PF('modalNewProduct').hide();}"/>
                </div>


            </h:form>
        </p:dialog>



    </ui:define>
</ui:composition>
